# ä¾èµ–æ³¨å…¥æ¶æ„è®¾è®¡è¯´æ˜

## ğŸ¯ è®¾è®¡åŸåˆ™

### ä¸ºä»€ä¹ˆå°†æœåŠ¡æ³¨å†Œæ”¾åœ¨ Program.cs è€Œä¸æ˜¯ App.axaml.csï¼Ÿ

## ğŸ“‹ å¯¹æ¯”åˆ†æ

### âŒ ä¹‹å‰çš„è®¾è®¡ï¼ˆåˆ†æ•£é…ç½®ï¼‰

```csharp
// Program.cs - åªè´Ÿè´£æ—¥å¿—é…ç½®
Log.Logger = LoggingConfiguration.ConfigureSerilog();

// App.axaml.cs - è´Ÿè´£æœåŠ¡æ³¨å†Œ
private void ConfigureServices()
{
    var services = new ServiceCollection();
    services.AddLogging(builder => builder.AddSerilog());
    services.AddSingleton<ILoggerService, LoggerService>();
    _serviceProvider = services.BuildServiceProvider();
}
```

**é—®é¢˜ï¼š**
- èŒè´£åˆ†æ•£ï¼šé…ç½®åˆ†å¸ƒåœ¨ä¸¤ä¸ªæ–‡ä»¶ä¸­
- ä¾èµ–æ··ä¹±ï¼šæ—¥å¿—é…ç½®åœ¨ Program.csï¼ŒæœåŠ¡æ³¨å†Œåœ¨ App.axaml.cs
- ä¸æ˜“ç»´æŠ¤ï¼šä¿®æ”¹æœåŠ¡é…ç½®éœ€è¦åœ¨å¤šä¸ªåœ°æ–¹æ”¹åŠ¨

### âœ… å½“å‰è®¾è®¡ï¼ˆé›†ä¸­é…ç½®ï¼‰

```csharp
// Program.cs - ç»Ÿä¸€è´Ÿè´£æ‰€æœ‰é…ç½®
public static void Main(string[] args)
{
    // 1. é…ç½®æ—¥å¿—
    Log.Logger = LoggingConfiguration.ConfigureSerilog();
    
    // 2. è®¾ç½®å¼‚å¸¸å¤„ç†
    SetupGlobalExceptionHandling();
    
    // 3. é…ç½®ä¾èµ–æ³¨å…¥
    ConfigureServices();
    
    // 4. å¯åŠ¨åº”ç”¨ç¨‹åº
    BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);
}

// App.axaml.cs - åªè´Ÿè´£ UI åˆå§‹åŒ–
public override void OnFrameworkInitializationCompleted()
{
    var mainWindowViewModel = Program.ServiceProvider.GetService<MainWindowViewModel>();
    desktop.MainWindow = new MainWindow { DataContext = mainWindowViewModel };
}
```

## ğŸ—ï¸ æ¶æ„ä¼˜åŠ¿

### 1. **å•ä¸€èŒè´£åŸåˆ™**
- `Program.cs`: åº”ç”¨ç¨‹åºå¯åŠ¨å’ŒåŸºç¡€è®¾æ–½é…ç½®
- `App.axaml.cs`: UI æ¡†æ¶åˆå§‹åŒ–å’Œçª—å£åˆ›å»º

### 2. **ä¾èµ–å…³ç³»æ¸…æ™°**
```
Program.cs (å¯åŠ¨å±‚)
â”œâ”€â”€ æ—¥å¿—é…ç½®
â”œâ”€â”€ å¼‚å¸¸å¤„ç†é…ç½®  
â”œâ”€â”€ ä¾èµ–æ³¨å…¥é…ç½®
â””â”€â”€ åº”ç”¨ç¨‹åºå¯åŠ¨
    â””â”€â”€ App.axaml.cs (UIå±‚)
        â””â”€â”€ çª—å£å’Œ ViewModel åˆå§‹åŒ–
```

### 3. **é…ç½®é›†ä¸­åŒ–**
- æ‰€æœ‰åŸºç¡€è®¾æ–½é…ç½®éƒ½åœ¨ `Program.cs` ä¸­
- ä¾¿äºç»Ÿä¸€ç®¡ç†å’Œä¿®æ”¹
- å¯åŠ¨é¡ºåºæ˜ç¡®

### 4. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```csharp
try
{
    // åº”ç”¨ç¨‹åºè¿è¡Œ
}
finally
{
    // ç»Ÿä¸€æ¸…ç†èµ„æº
    ServiceProvider?.Dispose();
    Log.CloseAndFlush();
}
```

## ğŸ”„ ä¸å…¶ä»–æ¡†æ¶çš„å¯¹æ¯”

### ASP.NET Core é£æ ¼
```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddLogging();
builder.Services.AddSingleton<IMyService, MyService>();
var app = builder.Build();
app.Run();
```

### æˆ‘ä»¬çš„ Avalonia é£æ ¼
```csharp
// Program.cs
Log.Logger = LoggingConfiguration.ConfigureSerilog();
ConfigureServices(); // é…ç½®æ‰€æœ‰æœåŠ¡
BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);
```

## ğŸ“Š æ—¥å¿—è¾“å‡ºå¯¹æ¯”

### é‡æ„å‰çš„æ—¥å¿—
```log
[22:24:37 INF] åº”ç”¨ç¨‹åºå¯åŠ¨ {}
[22:24:37 INF] MainWindowViewModel åˆå§‹åŒ–å¼€å§‹ {}
```

### é‡æ„åçš„æ—¥å¿—
```log
[22:27:21 INF] ä¾èµ–æ³¨å…¥æœåŠ¡é…ç½®å®Œæˆ {}
[22:27:21 INF] åº”ç”¨ç¨‹åºå¯åŠ¨ {}
[22:27:21 INF] MainWindowViewModel åˆå§‹åŒ–å¼€å§‹ {}
```

**æ”¹è¿›ï¼š**
- å¯ä»¥æ¸…æ¥šçœ‹åˆ°é…ç½®é˜¶æ®µçš„å®Œæˆ
- å¯åŠ¨æµç¨‹æ›´åŠ æ¸…æ™°
- ä¾¿äºè°ƒè¯•å’Œç›‘æ§

## ğŸ¨ æœ€ä½³å®è·µ

### 1. **æœåŠ¡æ³¨å†Œé¡ºåº**
```csharp
private static void ConfigureServices()
{
    var services = new ServiceCollection();
    
    // 1. åŸºç¡€æœåŠ¡ï¼ˆæ—¥å¿—ç­‰ï¼‰
    services.AddLogging(builder => builder.AddSerilog());
    
    // 2. ä¸šåŠ¡æœåŠ¡
    services.AddSingleton<ILoggerService, LoggerService>();
    
    // 3. UI æœåŠ¡ï¼ˆViewModels ç­‰ï¼‰
    services.AddTransient<MainWindowViewModel>();
    
    ServiceProvider = services.BuildServiceProvider();
}
```

### 2. **æœåŠ¡ç”Ÿå‘½å‘¨æœŸé€‰æ‹©**
- **Singleton**: å…¨å±€å”¯ä¸€å®ä¾‹ï¼ˆå¦‚æ—¥å¿—æœåŠ¡ï¼‰
- **Transient**: æ¯æ¬¡è¯·æ±‚æ–°å®ä¾‹ï¼ˆå¦‚ ViewModelsï¼‰
- **Scoped**: åœ¨ç‰¹å®šä½œç”¨åŸŸå†…å•ä¾‹ï¼ˆWeb åº”ç”¨å¸¸ç”¨ï¼Œæ¡Œé¢åº”ç”¨è¾ƒå°‘ï¼‰

### 3. **èµ„æºæ¸…ç†**
```csharp
finally
{
    Log.Information("åº”ç”¨ç¨‹åºå…³é—­");
    ServiceProvider?.Dispose(); // æ¸…ç†ä¾èµ–æ³¨å…¥å®¹å™¨
    Log.CloseAndFlush();        // åˆ·æ–°å¹¶å…³é—­æ—¥å¿—
}
```

## ğŸš€ æ‰©å±•å»ºè®®

### 1. **é…ç½®æ–‡ä»¶æ”¯æŒ**
```csharp
// æœªæ¥å¯ä»¥æ·»åŠ 
services.Configure<AppSettings>(configuration.GetSection("AppSettings"));
```

### 2. **ç¯å¢ƒåŒºåˆ†**
```csharp
// æ ¹æ®ç¯å¢ƒé…ç½®ä¸åŒçš„æœåŠ¡
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development")
{
    services.AddTransient<IDataService, MockDataService>();
}
else
{
    services.AddTransient<IDataService, RealDataService>();
}
```

### 3. **æœåŠ¡å¥åº·æ£€æŸ¥**
```csharp
// å¯åŠ¨æ—¶éªŒè¯å…³é”®æœåŠ¡
var logger = ServiceProvider.GetRequiredService<ILoggerService>();
logger.LogInformation("æ‰€æœ‰æœåŠ¡æ³¨å†ŒæˆåŠŸ");
```

---

è¿™ç§è®¾è®¡è®©æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå…·æœ‰æ¸…æ™°çš„æ¶æ„å±‚æ¬¡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ï¼
