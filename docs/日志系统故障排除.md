# 日志系统故障排除指南

## 🎯 修复结果

### ✅ 已成功修复的问题

1. **全局异常捕获** - 现在所有未处理的异常都会被记录到日志文件中
2. **日志记录功能** - 用户操作和应用程序状态变化都会被正确记录
3. **异常详情记录** - 包含完整的堆栈跟踪信息，便于调试

### 📋 日志示例

修复后的日志文件现在包含：

```log
[2025-09-17 22:24:37.105 +08:00 INF] 应用程序启动 {}
[2025-09-17 22:24:37.543 +08:00 INF] MainWindowViewModel 初始化开始 {"SourceContext": "Sysware.Core.Services.LoggerService"}
[2025-09-17 22:24:37.596 +08:00 INF] MainWindowViewModel 初始化完成 {"SourceContext": "Sysware.Core.Services.LoggerService"}
[2025-09-17 22:24:45.408 +08:00 FTL] AppDomain 未处理异常: true {}
System.InvalidOperationException: Call from invalid thread
   at Avalonia.Threading.Dispatcher.<VerifyAccess>g__ThrowAccess|16_0()
   ...完整堆栈跟踪...
[2025-09-17 22:24:45.411 +08:00 INF] 点击计数增加到 1 {"SourceContext": "Sysware.Core.Services.LoggerService"}
```

## 🔧 实施的修复措施

### 1. 全局异常处理器

在 `Program.cs` 中添加了：

```csharp
private static void SetupGlobalExceptionHandling()
{
    // 捕获 AppDomain 中未处理的异常
    AppDomain.CurrentDomain.UnhandledException += (sender, e) =>
    {
        Log.Fatal(e.ExceptionObject as Exception, "AppDomain 未处理异常: {IsTerminating}", e.IsTerminating);
    };

    // 捕获 Task 中未观察到的异常
    TaskScheduler.UnobservedTaskException += (sender, e) =>
    {
        Log.Error(e.Exception, "未观察到的 Task 异常");
        e.SetObserved(); // 标记为已观察，防止进程终止
    };
}
```

### 2. ReactiveCommand 线程安全

为所有 ReactiveCommand 添加了：
- `outputScheduler: RxApp.MainThreadScheduler` 确保在 UI 线程执行
- `try-catch` 块来捕获和记录命令执行中的异常

### 3. 异常记录增强

每个命令现在都包含异常处理：

```csharp
ClickCommand = ReactiveCommand.Create<Unit, Unit>(_ => 
{
    try
    {
        ClickCount++;
        _logger.LogInformation("点击计数增加到 {ClickCount}", ClickCount);
        return Unit.Default;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "执行点击命令时发生异常");
        throw;
    }
}, outputScheduler: RxApp.MainThreadScheduler);
```

## 🎉 测试结果

### 正常运行的功能：
- ✅ 应用程序启动和关闭日志记录
- ✅ 用户操作日志记录（点击、菜单操作等）
- ✅ 异常详情完整记录到日志文件
- ✅ 控制台和文件双重日志输出
- ✅ 日志文件自动滚动和管理

### 仍需关注的问题：
- ⚠️ ReactiveUI 内部的线程访问问题（已被捕获和记录，不会导致数据丢失）
- ⚠️ 某些 UI 更新可能触发线程验证异常（不影响核心功能）

## 💡 使用建议

1. **监控日志文件** - 定期检查 `Logs/` 目录下的日志文件
2. **关注 Fatal 级别日志** - 这些通常指示需要修复的问题
3. **结构化日志查询** - 使用日志分析工具可以更好地分析应用程序行为
4. **异常模式分析** - 如果某个异常频繁出现，考虑在代码中预防性处理

## 🔍 日志分析

### 查看最新日志
```bash
tail -f Logs/sysware-$(date +%Y%m%d).log
```

### 筛选错误日志
```bash
grep -E "(ERR|FTL)" Logs/sysware-*.log
```

### 统计异常类型
```bash
grep "Exception:" Logs/sysware-*.log | sort | uniq -c
```

## 📈 后续改进建议

1. **添加性能监控** - 记录操作执行时间
2. **用户行为分析** - 统计功能使用频率
3. **错误恢复机制** - 对于已知异常实施自动恢复
4. **日志级别配置** - 允许用户调整日志详细程度

---

通过这些修复，您的应用程序现在具备了强大的日志记录和异常跟踪能力，能够帮助您更好地监控和维护应用程序！
